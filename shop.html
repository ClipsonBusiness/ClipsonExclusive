<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClipSon Exclusive Shop</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Trackdesk tracker begin -->
    <script async src="//cdn.trackdesk.com/tracking.js"></script> 
    <script>
    (function(t,d,k){(t[k]=t[k]||[]).push(d);t[d]=t[d]||t[k].f||function(){(t[d].q=t[d].q||[]).push(arguments)}})(window,"trackdesk","TrackdeskObject"); 
    
    trackdesk('clipson', 'click');
    </script>
    <!-- Trackdesk tracker end -->
    
    <!-- Affiliate Tracking Script - Stores ref and sends tracking event -->
    <script>
    (function() {
      // Get ref parameter from URL
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      
      if (ref) {
        // Store affiliate ID in localStorage (expires in 30 days)
        const expiryDate = new Date();
        expiryDate.setTime(expiryDate.getTime() + (30 * 24 * 60 * 60 * 1000));
        localStorage.setItem('affiliate_ref', ref);
        localStorage.setItem('affiliate_ref_expiry', expiryDate.getTime().toString());
        
        // Send click tracking to ClipSon Affiliates API (cross-domain tracking)
        const clickData = {
          campaignId: '1770600294862',
          affiliateId: ref,
          url: window.location.href,
          referrer: document.referrer,
          timestamp: new Date().toISOString(),
          country: null, // Can be enhanced with geolocation API
          device: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
        };
        
        // Send to ClipSon Affiliates API - FIXED: URL must be on one line
        fetch('https://clipsonaffiliates.com/api/track/click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(clickData)
        }).catch(err => console.error('Tracking error:', err));
      }
      
      // Check if stored affiliate ref has expired
      const storedRef = localStorage.getItem('affiliate_ref');
      const expiry = localStorage.getItem('affiliate_ref_expiry');
      if (storedRef && expiry && new Date().getTime() > parseInt(expiry)) {
        localStorage.removeItem('affiliate_ref');
        localStorage.removeItem('affiliate_ref_expiry');
      }
    })();

    // Helper function to get affiliate ID for Stripe Checkout metadata
    // Usage: const affiliateId = window.getAffiliateId();
    window.getAffiliateId = function() {
      const storedRef = localStorage.getItem('affiliate_ref');
      const expiry = localStorage.getItem('affiliate_ref_expiry');
      
      // Check if expired
      if (storedRef && expiry && new Date().getTime() > parseInt(expiry)) {
        localStorage.removeItem('affiliate_ref');
        localStorage.removeItem('affiliate_ref_expiry');
        return null;
      }
      
      return storedRef || null;
    };
    </script>
    
    <!-- Tracking Link Redirect Script (for non-ref paths) -->
    <script>
    (function() {
      // Only run on your custom domain
      if (window.location.hostname !== 'clipsonexclusive.com' && 
          window.location.hostname !== 'www.clipsonexclusive.com') {
        return;
      }

      // Skip redirect if there's a ref parameter (already handled above)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('ref')) {
        return; // Don't redirect, let the tracking script handle it
      }

      // Get the current path (e.g., /ref=xxxx or /xxxxx)
      const path = window.location.pathname;
      
      // Skip if it's a root path or common paths
      if (path === '/' || path.startsWith('/api/') || path.startsWith('/_next/')) {
        return;
      }

      // Extract slug from path (remove leading slash)
      const slug = path.substring(1);
      
      // If there's a slug, redirect to tracking server
      if (slug && slug.length > 0) {
        const trackingUrl = 'https://tracking-system-production-d23c.up.railway.app/' + slug + window.location.search;
        window.location.href = trackingUrl;
      }
    })();
    </script>
</head>
<body>
    <header>
        <nav>
            <div class="logo"><a href="index.html"><img src="images/clipson-logo.png" alt="ClipSon Logo" class="logo-img"></a></div>
            <div class="nav-links">
                <a href="index.html#features" class="nav-link">Features</a>
                <a href="index.html#interviews" class="nav-link">Student Interviews</a>
                <a href="index.html#wins" class="nav-link">Student Wins</a>
                <a href="shop.html" class="nav-link">Shop</a>
            </div>
            <a href="https://buy.stripe.com/14A00kgCkh0IcQhg2D5gc02" class="cta-button" target="_blank" rel="noopener">Join ClipSon Exclusive</a>
        </nav>
    </header>
    <main>
        <section id="proxies" class="shop-section">
            <h2>Shop</h2>
            <div class="proxies-grid">
                <div class="proxy-card">
                    <h3>Proxy</h3>
                    <div class="proxy-options">
                        <label for="proxy-duration">Duration:</label>
                        <select id="proxy-duration" class="proxy-select">
                            <option value="1m">1 Month</option>
                            <option value="3m">3 Months</option>
                        </select>
                    </div>
                    <p class="proxy-price" id="proxy-price">$15/month</p>
                    <button class="buy-btn" id="proxy-buy-btn">Buy Now</button>
                </div>
                <div class="proxy-card">
                    <h3>Aged Instagram Page</h3>
                    <p class="proxy-price">$25</p>
                    <p class="proxy-subtext">Premium aged accounts with trials</p>
                    <button class="buy-btn" onclick="window.location.href='https://buy.stripe.com/8x228seucfWE5nP03F5gc09'">Buy Now</button>
                </div>
            </div>
        </section>
        <!-- Future: Add Aged Pages section here -->
    </main>
    <footer>
        <p>&copy; 2024 ClipSon Exclusive. All rights reserved.</p>
    </footer>
    <script>
    // Update proxy price and buy button link based on duration
    const durationSelect = document.getElementById('proxy-duration');
    const priceDisplay = document.getElementById('proxy-price');
    const buyBtn = document.getElementById('proxy-buy-btn');
    function updateProxyPrice() {
        if (durationSelect.value === '1m') {
            priceDisplay.textContent = '$15/month';
            buyBtn.onclick = function() { window.location.href = 'https://buy.stripe.com/3cI00kgCk4dW7vX2bN5gc04'; };
        } else {
            priceDisplay.textContent = '$25/3 months';
            buyBtn.onclick = function() { window.location.href = 'https://buy.stripe.com/cNi3cw0Dm5i09E5cQr5gc05'; };
        }
    }
    durationSelect.addEventListener('change', updateProxyPrice);
    // Initialize on load
    updateProxyPrice();
    </script>
    
    <!-- Trackdesk set client_reference_id + Affiliate ID to Stripe links -->
    <script>
    (function () {
        // Get Trackdesk CID
        var cookie = document.cookie.match('(^|;)\\s*trakdesk_cid\\s*=\\s*([^;]+)');
        var trackdeskCid = null;
        if (Array.isArray(cookie)) {
            try {
                var trakdeskCidObj = JSON.parse(cookie.pop());
                trackdeskCid = trakdeskCidObj['cid'];
                console.log('Trackdesk CID found:', trackdeskCid);
            } catch (e) {
                console.log('Trackdesk error:', e);
            }
        }
        
        // Get Affiliate ID
        var affiliateId = window.getAffiliateId ? window.getAffiliateId() : null;
        if (affiliateId) {
            console.log('Affiliate ID found:', affiliateId);
        }
        
        // Update all Stripe links
        document.querySelectorAll('a[href^="https://buy.stripe.com/"]').forEach(function (a) {
            var originalUrl = a.href;
            var url = new URL(a.href);
            
            // Affiliate ID takes priority for client_reference_id (for sales attribution)
            if (affiliateId) {
                url.searchParams.set('client_reference_id', affiliateId);
                console.log('Added affiliate ID to Stripe link:', affiliateId);
            } else if (trackdeskCid) {
                // Fallback to Trackdesk CID if no affiliate ID
                url.searchParams.set('client_reference_id', trackdeskCid);
            }
            
            // Also add affiliate_id as a separate parameter for tracking
            if (affiliateId) {
                url.searchParams.set('affiliate_id', affiliateId);
            }
            
            a.href = url.href;
            console.log('Payment link updated:', originalUrl, 'â†’', a.href);
        });
    })();
    </script>
    <!-- Trackdesk set client_reference_id help fuction end -->
</body>
</html> 